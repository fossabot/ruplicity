## Useful links

* tutorial on using FUSE filesystem in rust [part I](http://zsiciarz.github.io/24daysofrust/book/day15.html) and [part II](http://zsiciarz.github.io/24daysofrust/book/day16.html) and related [source code](https://github.com/zsiciarz/24daysofrust/blob/master/src/day15.rs);
* [tempfile library](https://www.reddit.com/r/rust/comments/32n864/tempfile_temporary_file_library/);
* how to restore duplicity backups in the [worst case](https://wiki.gnome.org/Apps/DejaDup/Help/Restore/WorstCase);
* [man rdiff](http://linux.die.net/man/1/rdiff).

## Duplicity

To restore a backup without passphrase into a directory use this command:

```
duplicity restore --no-encryption file://<absolute-path-of-backup> <path-to-restore>
```

To backup incrementally from an existing backup and a source directory:

```
duplicity incremental --no-encryption <source-dir> file://<absolute-path-of-backup>
```

To list current files in backup:

```
duplicity list-current-files --no-encryption file://<absolute-path-of-backup>
```

To list all the backup snapshots contained in a directory:

```
duplicity collection-status --no-encryption file://<absolute-path-of-backup>
```

## Duplicity file format

### Filenames

File extensions are used to determine if the file is compressed or encrypted:

* `.gz` is a compressed file;
* `.gpg` is an encrypted file.

File names are used to define the type, the time, the volume and the relationships between snapshots. Those files must obey certain regular expressions to be considered part of a duplicity backup.


### Signatures

A signature file is a tar file (compressed and/or encrypted) with a defined structure.
Every file in the tar is in one of the following folders:

* `signature`;
* `snapshot`;
* `deleted`.

Any other folder is ignored.

To determine which files belongs to a given snapshot, consider and sort the signature files up to the desired date. The algorithm works as follows:

1. open the tar files of all the signature files, and iterate over their first file (they are alphabetically ordered);
2. sort the resulting filenames by name and number of signature file; in this way, when the filenames are the same, the last signature file wins;
3. yield the top element of this list;
4. advance the iterators on the signature files; if a signature files comes to an end, remove it;
5. collect the resulting filenames;
6. go to point 2 if there are still filenames to consider.

### Signature file format

Signatures are generated by [librsync](https://github.com/librsync/librsync). See [mksum.c](https://github.com/librsync/librsync/blob/54e505667257fd1ea786454bea390784d817123c/mksum.c).

Duplicity uses md4 type signatures, because the header starts with: 0x72730136. The file format is the following:

- Header
  - 32b magic number (0x72730136 for MD4);
  - 32b block length;
  - 32b strong sum length (16 native MD4);
